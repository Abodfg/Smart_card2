<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Abod Store - متجر الخدمات الرقمية</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* الهوية البصرية المهنية */
            --primary-blue: #2D1B69;
            --light-blue: #1E88E5;
            --accent-cyan: #00E5FF;
            --orange: #FF6D00;
            --yellow: #FFD600;
            --pink: #FF4081;
            --white: #FFFFFF;
            --dark: #0A0A0A;
            --gray-light: #F5F5F5;
            --gray-medium: #CCCCCC;
            --gray-dark: #666666;
            
            /* تدرجات احترافية */
            --primary-gradient: linear-gradient(135deg, #2D1B69 0%, #1E88E5 50%, #00E5FF 100%);
            --accent-gradient: linear-gradient(135deg, #FF6D00 0%, #FFD600 100%);
            --success-gradient: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            --warning-gradient: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);
            
            /* ظلال احترافية */
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-strong: 0 8px 30px rgba(0, 0, 0, 0.2);
            
            /* انحناءات */
            --radius: 12px;
            --radius-large: 20px;
            
            /* مسافات */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            
            /* مدة الحركات */
            --transition: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
            direction: rtl;
            color: var(--dark);
        }

        /* الحاوي الرئيسي */
        .app-container {
            position: relative;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* الهيدر */
        .app-header {
            background: var(--primary-gradient);
            padding: var(--space-lg);
            text-align: center;
            color: var(--white);
            position: relative;
        }

        .logo-container {
            margin-bottom: var(--space-sm);
        }

        .logo-image {
            width: 80px;
            height: 60px;
            object-fit: contain;
            margin-bottom: var(--space-sm);
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: var(--space-xs);
        }

        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* المحتوى الرئيسي */
        .main-content {
            padding: var(--space-lg);
            padding-bottom: 100px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: var(--space-lg);
            text-align: center;
            color: var(--primary-blue);
        }

        /* البطاقات */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: var(--space-lg);
            box-shadow: var(--shadow-medium);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-strong);
            border-color: var(--light-blue);
        }

        .card-content {
            text-align: center;
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
            display: block;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--primary-blue);
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--gray-dark);
            line-height: 1.6;
            margin-bottom: var(--space-md);
        }

        .card-price {
            font-size: 22px;
            font-weight: 700;
            color: var(--orange);
            margin-bottom: var(--space-md);
        }

        /* الأزرار */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: 12px 24px;
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: var(--accent-gradient);
        }

        .btn.success {
            background: var(--success-gradient);
        }

        .btn.outline {
            background: transparent;
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
        }

        /* شارات */
        .badge {
            position: absolute;
            top: -8px;
            right: var(--space-sm);
            background: var(--accent-gradient);
            color: var(--white);
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 600;
            z-index: 2;
        }

        .badge.popular {
            background: var(--warning-gradient);
        }

        .badge.new {
            background: var(--success-gradient);
        }

        /* التنقل السفلي */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-medium);
            padding: var(--space-sm);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: var(--space-xs);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition);
            color: var(--gray-dark);
            flex: 1;
        }

        .nav-item.active {
            color: var(--primary-blue);
            background: rgba(45, 27, 105, 0.1);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-text {
            font-size: 12px;
            font-weight: 500;
        }

        /* شاشة التحميل */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--primary-blue);
            font-weight: 500;
        }

        /* الإشعارات */
        .notification {
            position: fixed;
            top: var(--space-md);
            right: var(--space-md);
            left: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-large);
            padding: var(--space-lg);
            box-shadow: var(--shadow-strong);
            transform: translateY(-100px);
            opacity: 0;
            transition: all var(--transition);
            z-index: 1001;
            max-width: 400px;
            margin: 0 auto;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-right: 4px solid #4CAF50;
        }

        .notification.error {
            border-right: 4px solid #F44336;
        }

        .notification-content {
            text-align: center;
        }

        .notification-icon {
            font-size: 28px;
            margin-bottom: var(--space-sm);
        }

        .notification-text {
            font-size: 14px;
            color: var(--dark);
            line-height: 1.5;
            white-space: pre-line;
        }

        /* قائمة الطلبات */
        .order-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border: 1px solid var(--gray-medium);
            box-shadow: var(--shadow-light);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .order-id {
            font-size: 14px;
            color: var(--gray-dark);
        }

        .order-status {
            padding: 4px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 600;
        }

        .order-status.completed {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .order-status.pending {
            background: #FFF3E0;
            color: #F57C00;
        }

        .order-details {
            margin-bottom: var(--space-sm);
        }

        .order-product {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .order-price {
            color: var(--orange);
            font-weight: 600;
        }

        .order-date {
            font-size: 12px;
            color: var(--gray-dark);
        }

        .order-code {
            background: var(--gray-light);
            padding: var(--space-sm);
            border-radius: var(--radius);
            margin-top: var(--space-sm);
            font-family: monospace;
            font-size: 14px;
            border: 1px dashed var(--gray-medium);
            cursor: pointer;
            transition: all var(--transition);
        }

        .order-code:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        /* معلومات المتجر */
        .info-section {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-medium);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--primary-blue);
        }

        .info-text {
            line-height: 1.6;
            color: var(--dark);
            margin-bottom: var(--space-md);
        }

        .contact-info {
            background: var(--gray-light);
            padding: var(--space-md);
            border-radius: var(--radius);
            text-align: center;
        }

        .contact-email {
            font-weight: 600;
            color: var(--primary-blue);
            text-decoration: none;
        }

        /* تحسينات الاستجابة */
        @media (max-width: 768px) {
            .main-content {
                padding: var(--space-md);
                padding-bottom: 100px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: var(--space-md);
            }
        }

        /* حالات خاصة */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--gray-dark);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .copy-btn {
            background: var(--success-gradient);
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: var(--space-xs);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- الهيدر -->
        <header class="app-header">
            <div class="logo-container">
                <img src="https://customer-assets.emergentagent.com/job_digicardbot/artifacts/anjzgr29_1759618204634.jpg" 
                     alt="Abod Store Logo" class="logo-image">
            </div>
            <h1 class="app-title">Abod Store</h1>
            <p class="app-subtitle">متجر الخدمات الرقمية والبطاقات الفورية</p>
        </header>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            
            <!-- الصفحة الرئيسية -->
            <section id="home-section" class="section active">
                <h2 class="section-title">الخدمات المتاحة</h2>
                <div class="cards-grid">
                    <div class="card" onclick="showSection('store')">
                        <div class="badge popular">الأكثر طلباً</div>
                        <div class="card-content">
                            <div class="card-icon">🛍️</div>
                            <h3 class="card-title">متجر المنتجات</h3>
                            <p class="card-subtitle">تسوق من مجموعة واسعة من البطاقات والخدمات الرقمية</p>
                            <button class="btn">تصفح المنتجات</button>
                        </div>
                    </div>

                    <div class="card" onclick="showSection('wallet')">
                        <div class="card-content">
                            <div class="card-icon">💰</div>
                            <h3 class="card-title">محفظتي</h3>
                            <p class="card-subtitle">إدارة رصيدك وعمليات الشحن بسهولة</p>
                            <button class="btn secondary">عرض المحفظة</button>
                        </div>
                    </div>

                    <div class="card" onclick="showSection('orders')">
                        <div class="card-content">
                            <div class="card-icon">📦</div>
                            <h3 class="card-title">طلباتي</h3>
                            <p class="card-subtitle">تتبع حالة جميع طلباتك السابقة والحالية</p>
                            <button class="btn">عرض الطلبات</button>
                        </div>
                    </div>

                    <div class="card" onclick="showSection('support')">
                        <div class="card-content">
                            <div class="card-icon">💬</div>
                            <h3 class="card-title">خدمة العملاء</h3>
                            <p class="card-subtitle">تواصل مع فريق الدعم للمساعدة والاستفسارات</p>
                            <button class="btn success">تواصل معنا</button>
                        </div>
                    </div>

                    <div class="card" onclick="showSection('about')">
                        <div class="card-content">
                            <div class="card-icon">ℹ️</div>
                            <h3 class="card-title">عن المتجر</h3>
                            <p class="card-subtitle">معلومات حول خدماتنا وطرق التواصل</p>
                            <button class="btn outline">المزيد</button>
                        </div>
                    </div>

                    <div class="card" onclick="showSection('profile')">
                        <div class="card-content">
                            <div class="card-icon">👤</div>
                            <h3 class="card-title">الملف الشخصي</h3>
                            <p class="card-subtitle">عرض معلومات حسابك وبياناتك الشخصية</p>
                            <button class="btn outline">عرض الملف</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم المتجر -->
            <section id="store-section" class="section">
                <h2 class="section-title">متجر المنتجات</h2>
                <div class="cards-grid" id="products-grid">
                    <!-- سيتم ملؤها من JavaScript -->
                </div>
            </section>

            <!-- قسم المحفظة -->
            <section id="wallet-section" class="section">
                <h2 class="section-title">محفظتي الرقمية</h2>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-content">
                            <div class="card-icon">💎</div>
                            <h3 class="card-title">الرصيد الحالي</h3>
                            <p class="card-price" id="user-balance">$0.00</p>
                            <p class="card-subtitle">رصيدك المتاح للشراء</p>
                            <button class="btn" onclick="chargeWallet()">شحن المحفظة</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div class="card-icon">📊</div>
                            <h3 class="card-title">إحصائيات الحساب</h3>
                            <p class="card-subtitle">إجمالي الطلبات: <span id="user-orders-count">0</span></p>
                            <p class="card-subtitle">تاريخ الانضمام: <span id="user-join-date">غير محدد</span></p>
                            <button class="btn outline">عرض التفاصيل</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم الطلبات -->
            <section id="orders-section" class="section">
                <h2 class="section-title">طلباتي</h2>
                <div id="orders-container">
                    <!-- سيتم ملؤها من JavaScript -->
                </div>
            </section>

            <!-- قسم الدعم -->
            <section id="support-section" class="section">
                <h2 class="section-title">خدمة العملاء</h2>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-content">
                            <div class="card-icon">💬</div>
                            <h3 class="card-title">المحادثة المباشرة</h3>
                            <p class="card-subtitle">تحدث مع فريق الدعم عبر البوت</p>
                            <button class="btn success" onclick="startSupportChat()">بدء المحادثة</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div class="card-icon">📧</div>
                            <h3 class="card-title">البريد الإلكتروني</h3>
                            <p class="card-subtitle">تواصل معنا عبر البريد الإلكتروني</p>
                            <div class="contact-info">
                                <a href="mailto:abod-store@outlook.com" class="contact-email">
                                    abod-store@outlook.com
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم عن المتجر -->
            <section id="about-section" class="section">
                <h2 class="section-title">عن متجر Abod Store</h2>
                
                <div class="info-section">
                    <h3 class="info-title">من نحن؟</h3>
                    <p class="info-text">
                        متجر Abod Store هو متجرك الرقمي المتخصص في تقديم أفضل الخدمات الرقمية والبطاقات الفورية. 
                        نحن نقدم مجموعة واسعة من بطاقات الألعاب، البطاقات المصرفية، وبطاقات التسوق الإلكتروني 
                        بأسعار تنافسية وخدمة عملاء متميزة.
                    </p>
                </div>

                <div class="info-section">
                    <h3 class="info-title">خدماتنا</h3>
                    <p class="info-text">
                        • بطاقات الألعاب والتطبيقات<br>
                        • بطاقات التسوق الإلكتروني<br>
                        • البطاقات المصرفية والدفع<br>
                        • خدمات الاشتراكات الرقمية<br>
                        • تسليم فوري وآمن<br>
                        • دعم فني على مدار الساعة
                    </p>
                </div>

                <div class="info-section">
                    <h3 class="info-title">تواصل معنا</h3>
                    <div class="contact-info">
                        <p>للاستفسارات والدعم الفني</p>
                        <a href="mailto:abod-store@outlook.com" class="contact-email">
                            abod-store@outlook.com
                        </a>
                    </div>
                </div>
            </section>

            <!-- قسم الملف الشخصي -->
            <section id="profile-section" class="section">
                <h2 class="section-title">الملف الشخصي</h2>
                <div class="info-section">
                    <h3 class="info-title">معلومات الحساب</h3>
                    <div class="cards-grid">
                        <div class="card">
                            <div class="card-content">
                                <div class="card-icon">👤</div>
                                <h3 class="card-title">البيانات الأساسية</h3>
                                <p class="card-subtitle">
                                    الاسم: <span id="profile-name">غير محدد</span><br>
                                    المعرف: <span id="profile-username">غير محدد</span><br>
                                    معرف التلجرام: <span id="profile-telegram-id">غير محدد</span>
                                </p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <div class="card-icon">📊</div>
                                <h3 class="card-title">إحصائيات</h3>
                                <p class="card-subtitle">
                                    الرصيد: <span id="profile-balance">$0.00</span><br>
                                    عدد الطلبات: <span id="profile-orders">0</span><br>
                                    تاريخ التسجيل: <span id="profile-join-date">غير محدد</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- التنقل السفلي -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showSection('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-text">الرئيسية</div>
            </div>
            <div class="nav-item" onclick="showSection('store')">
                <div class="nav-icon">🛍️</div>
                <div class="nav-text">المتجر</div>
            </div>
            <div class="nav-item" onclick="showSection('wallet')">
                <div class="nav-icon">💰</div>
                <div class="nav-text">المحفظة</div>
            </div>
            <div class="nav-item" onclick="showSection('orders')">
                <div class="nav-icon">📦</div>
                <div class="nav-text">طلباتي</div>
            </div>
            <div class="nav-item" onclick="showSection('support')">
                <div class="nav-icon">💬</div>
                <div class="nav-text">الدعم</div>
            </div>
        </nav>

        <!-- شاشة التحميل -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">جاري التحميل...</div>
        </div>

        <!-- الإشعارات -->
        <div id="notification" class="notification">
            <div class="notification-content">
                <div class="notification-icon" id="notification-icon">✅</div>
                <div class="notification-text" id="notification-text"></div>
            </div>
        </div>
    </div>

    <script>
        // إعداد Telegram Web App
        let tgWebApp = null;
        let userTelegramId = null;
        let userData = {};

        // تهيئة التطبيق
        function initApp() {
            // Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                tgWebApp = window.Telegram.WebApp;
                tgWebApp.ready();
                tgWebApp.expand();
                
                // إعداد المظهر
                tgWebApp.setHeaderColor('#2D1B69');
                tgWebApp.setBackgroundColor('#1E88E5');
                
                // الحصول على بيانات المستخدم
                if (tgWebApp.initDataUnsafe && tgWebApp.initDataUnsafe.user) {
                    userTelegramId = tgWebApp.initDataUnsafe.user.id;
                    userData = tgWebApp.initDataUnsafe.user;
                }
            }

            // احتياطي: الحصول من URL
            if (!userTelegramId) {
                const urlParams = new URLSearchParams(window.location.search);
                userTelegramId = urlParams.get('user_id');
            }

            // تحميل البيانات
            loadInitialData();
        }

        // API Base URL
        const API_BASE = window.location.origin + '/api';

        // تحميل البيانات الأولية
        async function loadInitialData() {
            showLoading();
            
            try {
                // تحميل جميع البيانات بالتوازي
                const [productsRes, categoriesRes, usersRes, ordersRes] = await Promise.all([
                    fetch(`${API_BASE}/products`),
                    fetch(`${API_BASE}/categories`),
                    userTelegramId ? fetch(`${API_BASE}/users`) : null,
                    userTelegramId ? fetch(`${API_BASE}/orders`) : null
                ]);

                const products = await productsRes.json();
                const categories = await categoriesRes.json();
                
                if (usersRes) {
                    const users = await usersRes.json();
                    const currentUser = users.find(u => u.telegram_id == userTelegramId);
                    if (currentUser) {
                        userData = { ...userData, ...currentUser };
                        updateUserInfo();
                    }
                }

                let userOrders = [];
                if (ordersRes) {
                    const allOrders = await ordersRes.json();
                    userOrders = allOrders.filter(order => order.telegram_id == userTelegramId);
                }

                // إعداد المتجر والطلبات
                setupStore(products, categories);
                setupOrders(userOrders);
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showNotification('حدث خطأ في تحميل البيانات', 'error');
            } finally {
                hideLoading();
            }
        }

        // تحديث معلومات المستخدم
        function updateUserInfo() {
            // تحديث الرصيد
            const balanceElements = document.querySelectorAll('#user-balance, #profile-balance');
            balanceElements.forEach(el => {
                if (userData.balance !== undefined) {
                    el.textContent = `$${userData.balance.toFixed(2)}`;
                }
            });

            // تحديث عدد الطلبات
            const ordersCountElements = document.querySelectorAll('#user-orders-count, #profile-orders');
            ordersCountElements.forEach(el => {
                if (userData.orders_count !== undefined) {
                    el.textContent = userData.orders_count;
                }
            });

            // تحديث تاريخ الانضمام
            const joinDateElements = document.querySelectorAll('#user-join-date, #profile-join-date');
            joinDateElements.forEach(el => {
                if (userData.join_date) {
                    const date = new Date(userData.join_date).toLocaleDateString('ar');
                    el.textContent = date;
                }
            });

            // تحديث الملف الشخصي
            if (userData.first_name) {
                document.getElementById('profile-name').textContent = userData.first_name;
            }
            if (userData.username) {
                document.getElementById('profile-username').textContent = '@' + userData.username;
            }
            if (userTelegramId) {
                document.getElementById('profile-telegram-id').textContent = userTelegramId;
            }
        }

        // إعداد المتجر
        function setupStore(products, categories) {
            const productsGrid = document.getElementById('products-grid');
            
            if (!products || products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔄</div>
                        <h3>قريباً</h3>
                        <p>نعمل على إضافة منتجات جديدة</p>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = products.map((product, index) => {
                let cardClass = 'card';
                let badge = '';
                
                if (index === 0) {
                    badge = '<div class="badge popular">الأفضل</div>';
                } else if (index === 1) {
                    badge = '<div class="badge new">جديد</div>';
                }
                
                return `
                    <div class="${cardClass}" onclick="loadProductCategories('${product.id}', '${product.name}')">
                        ${badge}
                        <div class="card-content">
                            <div class="card-icon">🎮</div>
                            <h3 class="card-title">${product.name}</h3>
                            <p class="card-subtitle">${product.description || 'منتج رقمي متميز'}</p>
                            <button class="btn">عرض الباقات</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // تحميل فئات المنتج
        async function loadProductCategories(productId, productName) {
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const allCategories = await response.json();
                const categories = allCategories.filter(c => c.product_id === productId);
                
                const productsGrid = document.getElementById('products-grid');
                
                if (categories.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">⚠️</div>
                            <h3>غير متوفر</h3>
                            <p>هذا المنتج غير متوفر حالياً</p>
                            <button class="btn" onclick="loadInitialData()">العودة للمتجر</button>
                        </div>
                    `;
                } else {
                    productsGrid.innerHTML = `
                        <div class="card" style="grid-column: 1 / -1; margin-bottom: 20px;">
                            <div class="card-content">
                                <h3 class="card-title" style="font-size: 24px;">${productName}</h3>
                                <p class="card-subtitle">اختر الباقة المناسبة لك</p>
                                <button class="btn outline" onclick="loadInitialData()">العودة للمتجر</button>
                            </div>
                        </div>
                        ${categories.map((category, index) => {
                            let cardClass = 'card';
                            let badge = '';
                            
                            if (index === 1 && categories.length > 2) {
                                badge = '<div class="badge popular">الأكثر طلباً</div>';
                            } else if (index === categories.length - 1 && categories.length > 1) {
                                badge = '<div class="badge new">أفضل قيمة</div>';
                            }
                            
                            return `
                                <div class="${cardClass}">
                                    ${badge}
                                    <div class="card-content">
                                        <div class="card-icon">💎</div>
                                        <h3 class="card-title">${category.name}</h3>
                                        <p class="card-subtitle">${category.description || 'باقة مميزة'}</p>
                                        <p class="card-price">$${category.price?.toFixed(2) || '0.00'}</p>
                                        <button class="btn" onclick="showPurchaseDetails('${category.id}', '${category.name}', ${category.price}, '${category.delivery_type}')">
                                            شراء الآن
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
            } catch (error) {
                console.error('خطأ في تحميل الفئات:', error);
                showNotification('خطأ في تحميل الفئات', 'error');
            } finally {
                hideLoading();
            }
        }

        // عرض تفاصيل الطلب قبل الشراء
        function showPurchaseDetails(categoryId, categoryName, price, deliveryType) {
            const confirmed = confirm(
                `تأكيد الطلب\n\n` +
                `المنتج: ${categoryName}\n` +
                `السعر: $${price.toFixed(2)}\n` +
                `طريقة التسليم: ${getDeliveryTypeName(deliveryType)}\n` +
                `الرصيد الحالي: $${userData.balance?.toFixed(2) || '0.00'}\n\n` +
                `هل تريد المتابعة؟`
            );

            if (confirmed) {
                purchaseCategory(categoryId, categoryName, price, deliveryType);
            }
        }

        // الحصول على اسم نوع التسليم
        function getDeliveryTypeName(type) {
            const types = {
                'code': 'تسليم كود فوري',
                'phone': 'إدخال رقم الهاتف',
                'email': 'إدخال الإيميل',
                'id': 'إدخال المعرف',
                'manual': 'تسليم يدوي'
            };
            return types[type] || 'غير محدد';
        }

        // شراء فئة
        async function purchaseCategory(categoryId, categoryName, price, deliveryType) {
            if (!userTelegramId) {
                showNotification('يرجى فتح التطبيق من خلال البوت', 'error');
                return;
            }

            if (userData.balance !== undefined && userData.balance < price) {
                showNotification(
                    `رصيد غير كافي\nرصيدك: $${userData.balance.toFixed(2)}\nالمطلوب: $${price.toFixed(2)}`, 
                    'error'
                );
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE}/purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_telegram_id: parseInt(userTelegramId),
                        category_id: categoryId,
                        delivery_type: deliveryType || 'code'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    let successMessage = '';
                    
                    if (result.order_type === 'instant') {
                        successMessage = `تم الشراء بنجاح!\n${categoryName}\nتم إرسال الكود إلى البوت`;
                    } else {
                        successMessage = `تم إنشاء الطلب بنجاح!\n${categoryName}\nسيتم التنفيذ خلال ${result.estimated_time || '10-30 دقيقة'}`;
                    }
                    
                    showNotification(successMessage, 'success');
                    
                    // تحديث الرصيد المحلي
                    if (userData.balance !== undefined) {
                        userData.balance -= price;
                        updateUserInfo();
                    }

                    // الانتقال لقسم الطلبات بعد 2 ثانية
                    setTimeout(() => {
                        showSection('orders');
                        loadInitialData(); // إعادة تحميل الطلبات
                    }, 2000);
                    
                } else {
                    let errorMessage = result.detail || result.message || 'فشل في إتمام الشراء';
                    showNotification(errorMessage, 'error');
                }

            } catch (error) {
                console.error('خطأ في الشراء:', error);
                showNotification('حدث خطأ أثناء الشراء', 'error');
            } finally {
                hideLoading();
            }
        }

        // إعداد قائمة الطلبات
        function setupOrders(orders) {
            const ordersContainer = document.getElementById('orders-container');
            
            if (!orders || orders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📦</div>
                        <h3>لا توجد طلبات</h3>
                        <p>لم تقم بأي طلبات حتى الآن</p>
                        <button class="btn" onclick="showSection('store')">تصفح المتجر</button>
                    </div>
                `;
                return;
            }

            // ترتيب الطلبات حسب التاريخ (الأحدث أولاً)
            orders.sort((a, b) => new Date(b.order_date) - new Date(a.order_date));

            ordersContainer.innerHTML = orders.map(order => {
                const orderDate = new Date(order.order_date).toLocaleDateString('ar');
                const orderTime = new Date(order.order_date).toLocaleTimeString('ar');
                
                let codeSection = '';
                if (order.status === 'completed' && order.code_sent) {
                    codeSection = `
                        <div class="order-code" onclick="copyToClipboard('${order.code_sent}', this)">
                            <strong>الكود:</strong> ${order.code_sent}
                            <button class="copy-btn">نسخ</button>
                        </div>
                    `;
                }

                return `
                    <div class="order-item">
                        <div class="order-header">
                            <div class="order-id">طلب #${order.id.substring(0, 8)}</div>
                            <div class="order-status ${order.status}">
                                ${order.status === 'completed' ? 'مكتمل' : 'قيد التنفيذ'}
                            </div>
                        </div>
                        <div class="order-details">
                            <div class="order-product">${order.product_name} - ${order.category_name}</div>
                            <div class="order-price">$${order.price?.toFixed(2) || '0.00'}</div>
                            <div class="order-date">${orderDate} - ${orderTime}</div>
                        </div>
                        ${codeSection}
                    </div>
                `;
            }).join('');
        }

        // نسخ النص إلى الحافظة
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = element.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'تم النسخ!';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                
                showNotification('تم نسخ الكود بنجاح', 'success');
            }).catch(() => {
                showNotification('فشل في نسخ الكود', 'error');
            });
        }

        // شحن المحفظة
        function chargeWallet() {
            if (tgWebApp && tgWebApp.sendData) {
                tgWebApp.sendData(JSON.stringify({ action: 'charge_wallet' }));
            } else {
                showNotification('يرجى استخدام البوت لشحن المحفظة', 'error');
            }
        }

        // بدء محادثة الدعم
        function startSupportChat() {
            if (tgWebApp && tgWebApp.sendData) {
                tgWebApp.sendData(JSON.stringify({ action: 'start_support' }));
            } else {
                showNotification('يرجى استخدام البوت للتواصل مع الدعم', 'error');
            }
        }

        // عرض قسم معين
        function showSection(sectionName) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // إظهار القسم المطلوب
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // تحديث التنقل السفلي
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = Array.from(document.querySelectorAll('.nav-item')).find(item => 
                item.getAttribute('onclick').includes(`'${sectionName}'`)
            );
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // إضافة haptic feedback
            if (tgWebApp && tgWebApp.HapticFeedback) {
                tgWebApp.HapticFeedback.impactOccurred('light');
            }
        }

        // عرض التحميل
        function showLoading() {
            document.getElementById('loading-screen').style.display = 'flex';
        }

        // إخفاء التحميل
        function hideLoading() {
            document.getElementById('loading-screen').style.display = 'none';
        }

        // عرض الإشعار
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const text = document.getElementById('notification-text');
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            icon.textContent = icons[type] || icons.success;
            text.textContent = message;
            
            notification.className = `notification ${type}`;
            
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);

            if (tgWebApp && tgWebApp.HapticFeedback) {
                if (type === 'success') {
                    tgWebApp.HapticFeedback.notificationOccurred('success');
                } else if (type === 'error') {
                    tgWebApp.HapticFeedback.notificationOccurred('error');
                } else {
                    tgWebApp.HapticFeedback.impactOccurred('light');
                }
            }
        }

        // تهيئة التطبيق عند التحميل
        document.addEventListener('DOMContentLoaded', initApp);

        // منع الإيماءات غير المرغوب فيها
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>